import cityData from"./city-data.json";export default class citySelector{constructor(t,{defaultData:e,actionName:i={title:"请选择地区",cancelBtn:"取消",confirmBtn:"确认"},tabs:s=["请选择","请选择","请选择"],errorTips:c={noPro:"请选择省份",noCity:"请选择城市",noDis:"请选择区域"}}={defaultData:{province:"",city:"",district:""},actionName:{title:"请选择地区",cancelBtn:"取消",confirmBtn:"确认"},tabs:["请选择","请选择","请选择"],errorTips:{noPro:"请选择省份",noCity:"请选择城市",noDis:"请选择区域"}}){this.getParentEl(t)&&(this.cityData=cityData,this.els={},this.actionName=i,this.tabs=s,this.data=e,this.errorTips=c,this.data.province||(this.currentIndex=0),this.data.province&&!this.data.city&&(this.currentIndex=1),(this.data.city&&!this.data.district||this.data.district)&&(this.currentIndex=2),this.init())}init(){this.renderBody(),this.getEl(),this.inputInit(),this.renderPro(),this.renderCity(),this.renderDis(),this.activeTab(),this.tabChange(),this.bindTabEvent(),this.bindEvents(),this.fillData()}renderBody(){let t=this._createEle(["city-selector-body"]);t.innerHTML=`\n        <div class="city-selector-action">\n                    <div class="city-selector-title">\n                        ${this.actionName.title}\n                    </div>\n                    <a class="city-selector-btn city-selector-cancel">\n                        ${this.actionName.cancelBtn}\n                    </a>\n                    <a class="city-selector-btn city-selector-confirm">\n                        ${this.actionName.confirmBtn}\n                    </a>\n                </div>\n                <div class="city-selector-tabs">\n                    <a class="city-selector-tab">${this.tabs[0]}</a>\n                    <a class="city-selector-tab">${this.tabs[1]}</a>\n                    <a class="city-selector-tab">${this.tabs[2]}</a>\n                </div>\n                <div class="city-selector-panels">\n                    <div class="city-selector-panel city-selector-province">\n                    </div>\n                    <div class="city-selector-panel city-selector-city">\n                    </div>\n                    <div class="city-selector-panel city-selector-district">\n                    </div>\n                </div>\n                <div class="city-selector-error-tips"></div>\n            </div>\n        `,this.parentEl.appendChild(t)}getEl(){this.els={citySelInput:this.parentEl.querySelector("input[data-type='city-selector']"),citySelBody:this.parentEl.querySelector(".city-selector-body"),citySelAct:this.parentEl.querySelector(".city-selector-action"),citySelTabs:Array.prototype.slice.call(this.parentEl.querySelectorAll(".city-selector-tab")),citySelPanels:this.parentEl.querySelector(".city-selector-panels"),citySelPanel:this.parentEl.querySelectorAll(".city-selector-panel"),citySelPro:this.parentEl.querySelector(".city-selector-province"),citySelCity:this.parentEl.querySelector(".city-selector-city"),citySelDis:this.parentEl.querySelector(".city-selector-district"),citySelConfirmBtn:this.parentEl.querySelector(".city-selector-confirm"),citySelCancelBtn:this.parentEl.querySelector(".city-selector-cancel"),errorTipModal:this.parentEl.querySelector(".city-selector-error-tips")}}inputInit(){if(!this.els.citySelInput)return console.error("未获取到城市选择器，可能是没有定义城市选择器的data-type属性");this.parentEl.setAttribute("onselectstart","return false"),this.els.citySelInput.setAttribute("readonly",""),this.simple=this.els.citySelInput.getAttribute("data-simple")||"false",this.force=this.els.citySelInput.getAttribute("data-force")||"false"}renderPro(){let t,e=this.parentEl.querySelector(".city-selector-province"),i=document.createDocumentFragment();for(const e in this.cityData)t=document.createElement("a"),t.innerHTML=`${e}`,t.setAttribute("data-value",`${e}`),this.data&&t.getAttribute("data-value")===this.data.province&&t.classList.add("active"),i.appendChild(t);e.appendChild(i);const s=Array.prototype.slice.call(this.els.citySelPro.querySelectorAll("a"));s.forEach(t=>{t.addEventListener("click",e=>{e.preventDefault(),e.target.getAttribute("data-value")!==this.data.province&&(s.forEach(t=>{t.classList.contains("active")&&t.classList.remove("active")}),this.els.citySelTabs[0].innerHTML=this.data.province=e.target.getAttribute("data-value"),t.classList.add("active"),this.renderCity(),this.data.city=this.data.district="",this.tabChange(),this.currentIndex=1,this.activeTab())})})}renderCity(){let t,e,i=this.parentEl.querySelector(".city-selector-city"),s=document.createDocumentFragment();this._delAllNodes(i),e=this.cityData[this.data.province]||{};for(const i in e)t=document.createElement("a"),t.innerHTML=`${i}`,t.setAttribute("data-value",`${i}`),t.getAttribute("data-value")===this.data.city&&t.classList.add("active"),s.appendChild(t);i.appendChild(s);const c=Array.prototype.slice.call(this.els.citySelCity.querySelectorAll("a"));c.forEach(t=>{t.addEventListener("click",e=>{e.preventDefault(),console.log(),e.target.getAttribute("data-value")!==this.data.city&&(c.forEach(t=>{t.classList.contains("active")&&t.classList.remove("active")}),this.els.citySelTabs[1].innerHTML=this.data.city=e.target.innerHTML,t.classList.add("active"),this.els.citySelPro.style.display="none",this.els.citySelDis.style.display="block",this.renderDis(),this.data.district="",this.tabChange(),this.currentIndex=2,this.activeTab())})})}renderDis(){let t,e,i=this.parentEl.querySelector(".city-selector-district"),s=document.createDocumentFragment();if(!this.cityData[this.data.province])return;e=this.cityData[this.data.province][this.data.city]||[],this._delAllNodes(i);for(const i in e)t=document.createElement("a"),t.innerHTML=`${e[i]}`,t.setAttribute("data-value",`${e[i]}`),t.getAttribute("data-value")===this.data.district&&t.classList.add("active"),s.appendChild(t);i.appendChild(s);const c=Array.prototype.slice.call(this.els.citySelDis.querySelectorAll("a"));c.forEach(t=>{t.addEventListener("click",e=>{e.preventDefault(),e.target.getAttribute("data-value")!==this.data.district&&(c.forEach(t=>{t.classList.contains("active")&&t.classList.remove("active")}),this.els.citySelTabs[2].innerHTML=this.data.district=e.target.innerHTML,t.classList.add("active"))})})}activeAction(){let t,e;for(this.els.activeEls=this.els.citySelPanels.querySelectorAll(".active"),e=this.els.activeEls.length,t=0;t<e;t++){if(!this.els.activeEls[t])return;this.els.citySelPanel[t].scrollTop=this.els.activeEls[t].offsetTop-160}}tabChange(){this.els.citySelTabs[0].innerHTML=this.data.province||this.tabs[0],this.els.citySelTabs[1].innerHTML=this.data.city||this.tabs[1],this.els.citySelTabs[2].innerHTML=this.data.district||this.tabs[2]}bindTabEvent(){this.els.citySelTabs[0].addEventListener("click",t=>{this.currentIndex=0,this.activeTab()}),this.els.citySelTabs[1].addEventListener("click",t=>{this.data.province?(this.currentIndex=1,this.activeTab()):this.showErrorModel()}),this.els.citySelTabs[2].addEventListener("click",t=>{this.data.city?(this.currentIndex=2,this.activeTab(),this.els.citySelPro.style.display="none",this.els.citySelDis.style.display="block"):this.showErrorModel()})}activeTab(){this.els.citySelTabs.forEach(t=>{t.classList.remove("active")}),0===this.currentIndex||1===this.currentIndex?(this.els.citySelPro.style.display="block",this.els.citySelDis.style.display="none"):(this.els.citySelPro.style.display="none",this.els.citySelDis.style.display="block"),this.els.citySelTabs[this.currentIndex].classList.add("active")}showErrorModel(){const t=()=>{this.els.errorTipModal.style.display="block",setTimeout(()=>{this.els.errorTipModal.style.display="none"},1500)};return this.data.province?this.data.city?!!this.data.district||(this.els.errorTipModal.innerHTML=this.errorTips.noDis,t(),!1):(this.els.errorTipModal.innerHTML=this.errorTips.noCity,t(),!1):(this.els.errorTipModal.innerHTML=this.errorTips.noPro,t(),!1)}bindEvents(){const t=document.querySelector("body"),e=()=>{this.fillData(),this.confirm&&this.confirm(this.data)};this.els.citySelConfirmBtn.addEventListener("click",()=>{"true"===this.force&&this.showErrorModel()?e():"false"===this.force&&e()}),this.els.citySelCancelBtn.addEventListener("click",()=>{this.cancel&&this.cancel()}),this.els.citySelInput.addEventListener("click",()=>{"block"===this.els.citySelBody.style.display?this.els.citySelBody.style.display="none":this.els.citySelBody.style.display="block",this.activeAction()}),t.addEventListener("click",t=>{const e=t.target;for(const t in this.els){if("true"===this.force&&e===this.els.citySelConfirmBtn&&!this.data.district)return;e!==this.els[t]&&e!==this.els.citySelInput&&"active"!==e.className&&"city-selector-title"!==e.className&&"city-selector-tabs"!==e.className&&"city-selector-tab"!==e.className&&"city-selector-tab active"!==e.className&&"city-selector-panels"!==e.className&&(this.els.citySelBody.style.display="none")}})}_createEle(t){if(!(t instanceof Array))return console.error("创建元素必须传入class数组");let e,i=document.createElement("div"),s=t.length;for(e=0;e<s;e++)i.classList.add(t[e]);return i}getParentEl(t){return t.length&&t.length>1?(console.error("传入的选择器应该是个唯一值"),!1):(this.parentEl=t instanceof Node?t:document.querySelector(t),!0)}_delAllNodes(t){t.innerHTML=""}fillData(){let t=JSON.parse(JSON.stringify(this.data));"true"===this.simple&&(t.province=t.province.replace(/[省,市,自治区,壮族,回族,维吾尔]/g,""),t.city=t.city.replace(/[市,地区,回族,蒙古,苗族,白族,傣族,景颇族,藏族,彝族,壮族,傈僳族,布依族,侗族]/g,"").replace("哈萨克","").replace("自治州","").replace("自治县",""),t.district=t.district.length>2?t.district.replace(/[市,区,县,旗]/g,""):t.district),t.province&&t.city&&t.district?this.els.citySelInput.value=`${t.province} - ${t.city} - ${t.district}`:t.province&&t.city&&!t.district?this.els.citySelInput.value=`${t.province} - ${t.city}`:!t.province||t.city||t.district?this.els.citySelInput.value="":this.els.citySelInput.value=`${t.province}`}}